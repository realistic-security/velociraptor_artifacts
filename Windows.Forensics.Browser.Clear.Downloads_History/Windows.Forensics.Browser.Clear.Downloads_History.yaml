name: Windows.Forensics.Browser.Clear.Downloads_History
author: GUELMAOUI Mohamed Amine @ RealisticSecurity
description: |

  This Artifact is designed to uncover intentionally deleted browser downloads, providing detailed insights into files deliberately removed from the browser history.
  
  - It starts by retrieving all entries from the browser history.

  - A function is then defined to sift through the browser history for a given record, looking for a match.

  - The tool proceeds to analyze the evidence of downloads, considering details like the downloaded file path, modification time, file hash, zone ID, host URL, and referrer URL.

  - The selected scope excludes downloads that no longer appear in the browser history, highlighting intentionally cleared entries.
  
# Can be CLIENT, CLIENT_EVENT, SERVER, SERVER_EVENT or NOTEBOOK
type: CLIENT

sources:
  - precondition:
      SELECT OS From info() where OS = 'windows' OR OS = 'linux' OR OS = 'darwin'

    query: |
      LET AllHistory <= SELECT visited_url FROM Artifact.Windows.Applications.Chrome.History()
      LET BrowserHistory(record) = SELECT visited_url FROM AllHistory WHERE visited_url =~ record LIMIT 1 

      SELECT *
      FROM foreach(
      row={
        SELECT *, regex_replace(re="\\s", replace="", source=HostUrl) AS URL
        FROM Artifact.Windows.Analysis.EvidenceOfDownload()
      },
      query={
        SELECT BrowserHistory(record=URL).visited_url AS DownloadHistory,
           DownloadedFilePath,
           Mtime,
           FileHash,
           ZoneId,
           HostUrl, 
           ReferrerUrl
        FROM scope() WHERE NOT DownloadHistory
      })

