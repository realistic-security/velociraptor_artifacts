name: Windows.Forensics.RDPCachBitmapFiles

author: mhammed.seddaoui@realistic-security.com

description: |
    This customized artifact is designed to extract bitmap files from RDP cache files using the bmctools utility.

   - It fetches the bmctools utility, available locally.

    - A temporary directory (TempDir) is created for storing extracted files, and it is cleared after each user operation.

    - Cached bin files are retrieved for each user on the client.

    - A sequence of queries is executed for each user 

        1. The artifact extracts bitmap files from the cache bin files using bmctools (exe version) and saves them in TempDir.

        2. TempDir is compressed and named after the username, then uploaded.

        3. The content of TempDir is deleted to prepare for the next username operation.

    - The final output includes compressed zip files containing extracted bitmap files for each user on each client.

# Can be CLIENT, CLIENT_EVENT, SERVER, SERVER_EVENT or NOTEBOOK
type: CLIENT

tools:
   - name: bmctools
     url: https://github.com/0xhunter213/bmcexe/raw/main/bmctools.exe
     serve_locally: true
     
parameters:
   - name: RDPCacheGlob
     default: C:\{{Users,Windows.old\Users}\*\AppData\Local,Documents and Settings\*\Local Settings\Application Data}\Microsoft\Terminal Server Client\Cache\*.bin
   - name: Accessor
     description: Set accessor to use. blank is default, file for api, ntfs for raw, ntfs_vss for vss
     
sources:
  - precondition:
        SELECT OS From info() where OS = 'windows'
        
    query: |
     -- Check if bmc-tools is in the cache; if not, download it from the bmctools URL.
     LET hostname <= SELECT Hostname FROM info()
     LET bmcexe <= SELECT *
       FROM Artifact.Generic.Utils.FetchBinary(ToolName="bmctools",
                                               IsExecutable=FALSE)
     -- Create Temporary Folder
     LET TempDir <= tempdir(
         remove_last=True)
     SELECT *
     FROM foreach(
       -- Retrieve usernames on the client with cached bin files.  
       row={
         SELECT 
                path_split(
                  path=str(
                    str=OSPath))[2] AS username
         FROM glob(globs=RDPCacheGlob,
                   accessor=Accessor)
         WHERE Size > 0
         GROUP BY username
       },
       query={
         SELECT *
         FROM chain(
           /*
         Create a sequence of queries executed for each user:
             1- Retrieve cache bin file paths and extract bitmap files using bmc-tools (exe version).
             2- Compress TempDir and name it username.zip, then upload it.
             3- Delete the content of TempDir to make it empty for the next username operation.
         */
           a={
             SELECT *
             FROM foreach(
               row={
                 -- Retrieve cache bins for the specified `username`
                 SELECT 
                        OSPath
                 FROM glob(globs=RDPCacheGlob,
                           accessor=Accessor)
                 WHERE Size > 0
                  and OSPath =~ username+"\\\\"
               },
               query={
                 -- Extract bitmap files from the cache bin file and save the resulting files in the TempDir.
                 SELECT *
                 FROM execve(
                   argv=["cmd.exe", "/c", bmcexe.FullPath[0], "-s", OSPath, "-d", TempDir])
               })
           },
           b={
             -- Compress the folder and upload it with the user's name.
             SELECT hostname.Hostname[0] As HostName, 
                    upload(
                      file=TempDir + "\\" + username + ".zip",
                      name=username + ".zip") AS UploadFiles
             FROM execve(
               argv=["powershell.exe", "-c", "Compress-Archive", "-Path", TempDir + "\\*", "-DestinationPath", "'"+TempDir + "\\" + username+".zip'", "-CompressionLevel", "Fastest"])
           },
           c={
             -- Empty the TempDir to make it ready for the next set of files related to a different username.
             SELECT *
             FROM execve(argv=["powershell.exe", "-c", "rm", TempDir + "\\*"])
           })
       })
